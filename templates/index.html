<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Job Matcher Dashboard</title>
  <!-- Bootstrap CSS (Replit-themed) -->
  <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
</head>
<body>
  <div class="container-fluid mt-3">
    <h2 class="mb-3"><i class="fas fa-search me-2"></i>AI Job Matcher</h1>
    <!-- Alert Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% include 'resume/resumeSection.html' %}
    {% include 'jobs/jobSection.html' %}
    {% include 'jobs/tableSection.html' %}        
    {% include 'sync/syncSection.html' %}        
    <footer class="bg-dark text-center text-white p-3 mt-5">
      <div class="container">
        <p class="mb-0">Â© 2025 AI Job Matcher | Powered by Adzuna API</p>
      </div>
    </footer>
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="{{ url_for('static', filename='js/jobSection.js') }}"></script>
    <script src="{{ url_for('static', filename='js/syncSection.js') }}"></script>
    <script src="{{ url_for('static', filename='js/resumeSection.js') }}"></script>
    <script>
      // Global variables to store current tables and jobs data
      let jobTables = {};
      // Initialize everything when document is ready
      $(document).ready(function() {
        // Add event handler for batch deletion
        $(document).on('click', '.delete-batch', function() {
          const batchId = $(this).data('batch-id');
          if (confirm('Are you sure you want to delete this batch? This action cannot be undone.')) {
            deleteBatch(batchId);
          }
        });
        // Initialize saved search
        loadSavedSearch();
        // Initialize tables
        initializeJobTables();
        // === Inserted from main.js ===
        $(document).on('click', '.toggle-job-details', function() {
          const jobId = $(this).data('job-id');
          const detailsRow = $('#job-details-' + jobId);
          detailsRow.toggleClass('d-none');
        });
      });
      // Initialize job tables with proper configuration
      // Function to delete a batch
      function deleteBatch(batchId) {
        $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
        $('#syncStatusText').text('Deleting batch...');
        
        $.ajax({
          url: `/api/adzuna/batch/${batchId}`,
          method: 'DELETE',
          success: function(response) {
            if (response.success) {
              $('#syncStatus').removeClass('alert-info').addClass('alert-success');
              $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> Batch deleted successfully.`);
              // Remove the row from the table
              $(`button.delete-batch[data-batch-id="${batchId}"]`).closest('tr').remove();
              // Reload the page after a short delay to refresh the data
              setTimeout(function() {
                location.reload();
              }, 2000);
            } else {
              $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
              $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
            }
          },
          error: function(xhr, status, error) {
            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
            let errorMsg = 'Unknown error';
            
            if (xhr.responseJSON && xhr.responseJSON.error) {
              errorMsg = xhr.responseJSON.error;
            } else if (error) {
              errorMsg = error;
            }
            
            $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
          }
        });
      }
      function initializeJobTables() {
        try {
          // Wait for the DOM to be fully ready
          $(document).ready(function() {
            // Super basic configuration - minimum features to ensure it works
            const tableConfig = {
              pageLength: 10,
              processing: true,
              retrieve: true // Allow the table to be retrieved again
            };
            // Special config for job tables (with match percentage)
            const jobTableConfig = {
              ...tableConfig,
              order: [[6, 'desc']], // Sort by match percentage column by default
              columnDefs: [
                {
                  targets: 6, // Match percentage column
                  render: function(data, type, row) {
                    if (type === 'sort' || type === 'type') {
                      // Extract numeric part for sorting
                      return parseFloat(data) || 0;
                    }
                    return data;
                  }
                }
              ]
            };
            // Special config for batch summary table
            const batchTableConfig = {
              ...tableConfig,
              order: [[1, 'desc']], // Sort by timestamp by default
              columnDefs: []
            };
            // Initialize all tables with a delay to ensure DOM is ready
            setTimeout(function() {
              $('.job-table').each(function() {
                // Skip if table has no rows besides the empty message
                if ($(this).find('tbody tr').length === 0 || 
                  ($(this).find('tbody tr').length === 1 && 
                   $(this).find('tbody tr:first td').length === 1) ||
                  ($(this).find('tbody tr:first td:first').text().trim() === 'No jobs found' ||
                   $(this).find('tbody tr:first td:first').text().trim() === 'No recent jobs found' ||
                   $(this).find('tbody tr:first td:first').text().trim() === 'No remote jobs found' ||
                   $(this).find('tbody tr:first td:first').text().trim() === 'No data available')) {
                  console.log("Skipping empty table:", $(this).attr('id'));
                  return;
                }
                try {
                  const tableId = '#' + $(this).attr('id');
                  // Destroy existing table if it exists
                  if ($.fn.DataTable.isDataTable(tableId)) {
                    $(tableId).DataTable().destroy();
                  }
                  // Check if table has a header row
                  if ($(tableId + ' thead tr th').length === 0) {
                    console.log("Table has no header row:", tableId);
                    return;
                  }
                  // Create new table with safer configuration and error handling
                  try {
                    let config = tableConfig;
                    // Use appropriate config based on table type
                    if (tableId === '#batchSummaryTable') {
                      config = batchTableConfig;
                    } else if (['#jobsTable', '#recentJobsTable', '#remoteJobsTable'].includes(tableId)) {
                      config = jobTableConfig;
                    }
                    const table = $(tableId).DataTable({
                      ...config,
                      // Handle errors gracefully
                      language: {
                        emptyTable: tableId === '#batchSummaryTable' ? "No batches available" : "No job data available"
                      }
                    });
                    jobTables[tableId] = table;
                    console.log("Table initialized:", tableId);
                  } catch (dtError) {
                    console.error("DataTables initialization error:", dtError);
                  }
                } catch (tableError) {
                  console.error("Error initializing table:", $(this).attr('id'), tableError);
                }
              });
            });
            console.log("Tables initialization complete");
          }, 500);
        } catch (error) {
          console.error("Error in table initialization function:", error);
        }
      }
    </script>
</body>
</html>
