<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Matcher Dashboard</title>
    <!-- Bootstrap CSS (Replit-themed) -->
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
</head>
<body>
    <div class="container-fluid mt-3">
        <h2 class="mb-3"><i class="fas fa-search me-2"></i>AI Job Matcher</h1>
        
        <!-- Alert Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Upload Resume Section -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_resume') }}" enctype="multipart/form-data" class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="resume" class="form-label">Upload Resume (PDF, DOCX, or TXT)</label>
                            <input class="form-control" type="file" id="resume" name="resume" accept=".pdf,.docx,.txt" required>
                        </div>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-upload me-1"></i> Upload Resume & Find Matches
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main Dashboard Section -->
        <div class="row mb-4">
            <!-- Left Column: Stats -->
            <div class="col-md-8">
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Total Jobs</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ total_jobs|default('0') }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-briefcase fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Last 7 Days</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ recent_jobs|default('0') }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-calendar-week fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                            Last Sync</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ last_sync|default('Never') }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-sync fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                            Next Sync</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ next_sync|default('Manual Only') }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Resume History -->
            <div class="col-md-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold">Resume History</h6>
                    </div>
                    <div class="card-body">
                        {% if stored_resumes %}
                            <div class="list-group">
                                {% for resume in stored_resumes %}
                                    <a href="{{ url_for('match_resume', resume_id=resume.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        <div>
                                            <span>{{ resume.filename }}</span>
                                            <small class="d-block text-muted">{{ resume.upload_date }}</small>
                                        </div>
                                        <form action="{{ url_for('delete_resume', resume_id=resume.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this resume?');" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                No resumes uploaded yet. Use the form above to upload your resume.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Job Listings Section -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold">Job Listings</h6>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="jobActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw"></i> Actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="jobActionsDropdown">
                        <li><a class="dropdown-item" href="#" onclick="exportJobs()">
                            <i class="fas fa-download fa-sm fa-fw me-2 text-gray-400"></i>
                            Export Jobs
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="importToMainStorage()">
                            <i class="fas fa-database fa-sm fa-fw me-2 text-gray-400"></i>
                            Import to Main Storage
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="cleanupOldJobs()">
                            <i class="fas fa-trash fa-sm fa-fw me-2 text-gray-400"></i>
                            Clean Up Old Jobs
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="jobsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-jobs-tab" data-bs-toggle="tab" data-bs-target="#all-jobs" type="button" role="tab" aria-controls="all-jobs" aria-selected="true">All Jobs</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="recent-tab" data-bs-toggle="tab" data-bs-target="#recent" type="button" role="tab" aria-controls="recent" aria-selected="false">Recent (7 Days)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="remote-tab" data-bs-toggle="tab" data-bs-target="#remote" type="button" role="tab" aria-controls="remote" aria-selected="false">Remote Only</button>
                    </li>
                </ul>
                <div class="tab-content mt-4" id="jobsTabContent">
                    <div class="tab-pane fade show active" id="all-jobs" role="tabpanel" aria-labelledby="all-jobs-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="jobsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Company</th>
                                        <th>Location</th>
                                        <th>Remote</th>
                                        <th>Date Posted</th>
                                        <th>Salary</th>
                                        <th>Match %</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if jobs %}
                                        {% for job_id, job in jobs.items() %}
                                            <tr class="job-row" data-job-id="{{ job_id }}">
                                                <td>{{ job.title }}</td>
                                                <td>{{ job.company }}</td>
                                                <td>{{ job.location }}</td>
                                                <td>{{ 'Yes' if job.is_remote else 'No' }}</td>
                                                <td>{{ job.posted_date }}</td>
                                                <td>{{ job.salary_range|default('Not specified') }}</td>
                                                <td>{{ job.match_percentage|default('N/A') }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-info toggle-job-details" data-job-id="{{ job_id }}">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Visit Job Listing">
                                                        <i class="fas fa-external-link-alt"></i> Apply
                                                    </a>
                                                </td>
                                            </tr>
                                            <!-- Collapsible job description row -->
                                            <tr class="job-details-row d-none" id="job-details-{{ job_id }}">
                                                <td colspan="8">
                                                    <div class="job-details-content p-3">
                                                        <h5>{{ job.title }} at {{ job.company }}</h5>
                                                        {% if job.skills %}
                                                            <div class="mb-3">
                                                                <strong>Skills:</strong>
                                                                <div class="mt-1">
                                                                    {% for skill in job.skills %}
                                                                        <span class="badge bg-secondary me-1 mb-1">{{ skill }}</span>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        <div class="mb-3">
                                                            <strong>Description:</strong>
                                                            <div class="job-description mt-2">
                                                                {{ job.description|safe }}
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <a href="{{ job.url }}" target="_blank" class="btn btn-primary">
                                                                <i class="fas fa-external-link-alt me-1"></i> Apply for This Position
                                                            </a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="8" class="text-center">No jobs found. <a href="#" onclick="syncJobsNow()">Sync jobs now</a>.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="recent" role="tabpanel" aria-labelledby="recent-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="recentJobsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Company</th>
                                        <th>Location</th>
                                        <th>Remote</th>
                                        <th>Date Posted</th>
                                        <th>Salary</th>
                                        <th>Match %</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if recent_jobs_list %}
                                        {% for job_id, job in recent_jobs_list.items() %}
                                            <tr class="job-row" data-job-id="recent-{{ job_id }}">
                                                <td>{{ job.title }}</td>
                                                <td>{{ job.company }}</td>
                                                <td>{{ job.location }}</td>
                                                <td>{{ 'Yes' if job.is_remote else 'No' }}</td>
                                                <td>{{ job.posted_date }}</td>
                                                <td>{{ job.salary_range|default('Not specified') }}</td>
                                                <td>{{ job.match_percentage|default('N/A') }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-info toggle-job-details" data-job-id="recent-{{ job_id }}">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Visit Job Listing">
                                                        <i class="fas fa-external-link-alt"></i> Apply
                                                    </a>
                                                </td>
                                            </tr>
                                            <!-- Collapsible job description row -->
                                            <tr class="job-details-row d-none" id="job-details-recent-{{ job_id }}">
                                                <td colspan="8">
                                                    <div class="job-details-content p-3">
                                                        <h5>{{ job.title }} at {{ job.company }}</h5>
                                                        {% if job.skills %}
                                                            <div class="mb-3">
                                                                <strong>Skills:</strong>
                                                                <div class="mt-1">
                                                                    {% for skill in job.skills %}
                                                                        <span class="badge bg-secondary me-1 mb-1">{{ skill }}</span>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        <div class="mb-3">
                                                            <strong>Description:</strong>
                                                            <div class="job-description mt-2">
                                                                {{ job.description|safe }}
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <a href="{{ job.url }}" target="_blank" class="btn btn-primary">
                                                                <i class="fas fa-external-link-alt me-1"></i> Apply for This Position
                                                            </a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="8" class="text-center">No recent jobs found.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="remote" role="tabpanel" aria-labelledby="remote-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="remoteJobsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Company</th>
                                        <th>Location</th>
                                        <th>Date Posted</th>
                                        <th>Salary</th>
                                        <th>Match %</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if remote_jobs_list %}
                                        {% for job_id, job in remote_jobs_list.items() %}
                                            <tr class="job-row" data-job-id="remote-{{ job_id }}">
                                                <td>{{ job.title }}</td>
                                                <td>{{ job.company }}</td>
                                                <td>{{ job.location }}</td>
                                                <td>{{ job.posted_date }}</td>
                                                <td>{{ job.salary_range|default('Not specified') }}</td>
                                                <td>{{ job.match_percentage|default('N/A') }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-info toggle-job-details" data-job-id="remote-{{ job_id }}">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Visit Job Listing">
                                                        <i class="fas fa-external-link-alt"></i> Apply
                                                    </a>
                                                </td>
                                            </tr>
                                            <!-- Collapsible job description row -->
                                            <tr class="job-details-row d-none" id="job-details-remote-{{ job_id }}">
                                                <td colspan="7">
                                                    <div class="job-details-content p-3">
                                                        <h5>{{ job.title }} at {{ job.company }}</h5>
                                                        {% if job.skills %}
                                                            <div class="mb-3">
                                                                <strong>Skills:</strong>
                                                                <div class="mt-1">
                                                                    {% for skill in job.skills %}
                                                                        <span class="badge bg-secondary me-1 mb-1">{{ skill }}</span>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        <div class="mb-3">
                                                            <strong>Description:</strong>
                                                            <div class="job-description mt-2">
                                                                {{ job.description|safe }}
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <a href="{{ job.url }}" target="_blank" class="btn btn-primary">
                                                                <i class="fas fa-external-link-alt me-1"></i> Apply for This Position
                                                            </a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="7" class="text-center">No remote jobs found.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sync Status Alert -->
        <div class="alert alert-info alert-dismissible fade show mb-4" id="syncStatus" style="display: none;" role="alert">
            <span id="syncStatusText">Syncing jobs...</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <!-- Job Source Settings (moved from Settings page) -->
        <div id="jobSourceSettings" class="card-body pb-0 border-bottom">
            <div class="row">
                <div class="col-lg-9">
                    <h6 class="mb-3">Job Search Parameters</h6>
                    <form id="jobSearchForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="country" class="form-label">Country</label>
                            <select class="form-select" id="country" name="country">
                                <option value="gb" {% if not country or country == 'gb' %}selected{% endif %}>United Kingdom (gb)</option>
                                <option value="us" {% if country == 'us' %}selected{% endif %}>United States (us)</option>
                                <option value="ca" {% if country == 'ca' %}selected{% endif %}>Canada (ca)</option>
                                <option value="de" {% if country == 'de' %}selected{% endif %}>Germany (de)</option>
                                <option value="fr" {% if country == 'fr' %}selected{% endif %}>France (fr)</option>
                                <option value="au" {% if country == 'au' %}selected{% endif %}>Australia (au)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="search_location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="search_location" name="location" value="{{ location|default('') }}" placeholder="e.g., London, New York">
                        </div>
                        <div class="col-md-4">
                            <label for="search_keywords" class="form-label">Keywords</label>
                            <input type="text" class="form-control" id="search_keywords" name="keywords" value="{{ keywords|default('') }}" placeholder="e.g., Python Developer">
                        </div>
                        <div class="col-md-3">
                            <label for="max_days_old" class="form-label">Max Days Old</label>
                            <select class="form-select" id="max_days_old" name="max_days_old">
                                <option value="1" {% if max_days_old == 1 %}selected{% endif %}>1 day</option>
                                <option value="3" {% if max_days_old == 3 %}selected{% endif %}>3 days</option>
                                <option value="7" {% if max_days_old == 7 %}selected{% endif %}>1 week</option>
                                <option value="14" {% if max_days_old == 14 %}selected{% endif %}>2 weeks</option>
                                <option value="30" {% if not max_days_old or max_days_old == 30 %}selected{% endif %}>30 days</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="mt-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="remote_only" name="remote_only" value="1" {% if remote_only %}checked{% endif %}>
                                    <label class="form-check-label" for="remote_only">
                                        Remote Jobs Only
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mt-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="scheduler_enabled" name="scheduler_enabled" value="1" {% if scheduler_status and scheduler_status.is_running %}checked{% endif %}>
                                    <label class="form-check-label" for="scheduler_enabled">
                                        Enable Daily Job Sync at
                                    </label>
                                    <input type="time" class="form-control-sm ms-2 d-inline-block" style="width: 100px;" id="daily_sync_time" name="daily_sync_time" value="{{ daily_sync_time|default('02:00') }}">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mt-2">
                            <button type="button" class="btn btn-primary" onclick="saveJobSearchSettings()">
                                <i class="fas fa-save me-1"></i> Save Settings
                            </button>
                            <button type="button" class="btn btn-success ms-2" onclick="startJobSyncWithSettings()">
                                <i class="fas fa-sync-alt me-1"></i> Save & Sync Now
                            </button>
                        </div>
                    </form>
                </div>
                <div class="col-lg-3">
                    <h6 class="mb-3">API Rate Limiting</h6>
                    <div class="form-group mb-2">
                        <label for="call_delay" class="form-label small">API Call Delay (sec)</label>
                        <input type="number" class="form-control form-control-sm" id="call_delay" name="call_delay" min="0" max="60" value="{{ call_delay|default(3) }}">
                    </div>
                    <div class="form-group mb-2">
                        <label for="rate_limit_calls" class="form-label small">Calls Per Period</label>
                        <input type="number" class="form-control form-control-sm" id="rate_limit_calls" name="rate_limit_calls" min="1" max="100" value="{{ rate_limit_calls|default(20) }}">
                    </div>
                    <div class="form-group mb-2">
                        <label for="rate_limit_period" class="form-label small">Period (seconds)</label>
                        <input type="number" class="form-control form-control-sm" id="rate_limit_period" name="rate_limit_period" min="30" max="600" value="{{ rate_limit_period|default(60) }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync Progress Bar (initially hidden) -->
        <div id="syncProgressContainer" class="card-body pb-0" style="display:none;">
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="mb-0" id="syncStatusText">Syncing jobs...</h6>
                    <span class="text-muted" id="syncProgressPercent">0%</span>
                </div>
                <div class="progress">
                    <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="row text-center mb-2 small">
                <div class="col">
                    <span class="text-muted">Current Page: </span>
                    <span id="currentPageValue">0</span>/<span id="totalPagesValue">0</span>
                </div>
                <div class="col">
                    <span class="text-muted">Jobs Found: </span>
                    <span id="jobsFoundValue">0</span>
                </div>
                <div class="col">
                    <span class="text-muted">Estimated Completion: </span>
                    <span id="estimatedTimeValue">Calculating...</span>
                </div>
            </div>

        <!-- Sync Jobs Form -->
        <div class="card shadow mb-4" id="start-sync">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Bulk Sync Jobs</h6>
            </div>
            <div class="card-body">
                <form id="bulkSyncForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="keywords" class="form-label">Keywords (optional)</label>
                            <input type="text" class="form-control" id="keywords" placeholder="e.g., python developer" value="{{ keywords }}">
                        </div>
                        <div class="col-md-6">
                            <label for="location" class="form-label">Location (optional)</label>
                            <input type="text" class="form-control" id="location" placeholder="e.g., London" value="{{ location }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="country" class="form-label">Country</label>
                            <select class="form-select" id="country">
                                <option value="gb" {% if country == 'gb' %}selected{% endif %}>United Kingdom</option>
                                <option value="us" {% if country == 'us' %}selected{% endif %}>United States</option>
                                <option value="ca" {% if country == 'ca' %}selected{% endif %}>Canada</option>
                                <option value="au" {% if country == 'au' %}selected{% endif %}>Australia</option>
                                <option value="de" {% if country == 'de' %}selected{% endif %}>Germany</option>
                                <option value="fr" {% if country == 'fr' %}selected{% endif %}>France</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="maxPages" class="form-label">Max Pages (optional)</label>
                            <input type="number" class="form-control" id="maxPages" placeholder="Leave empty for all pages">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="maxDaysOld" class="form-label">Max Days Old</label>
                            <select class="form-select" id="maxDaysOld">
                                <option value="1" {% if max_days_old == '1' %}selected{% endif %}>1 day</option>
                                <option value="3" {% if max_days_old == '3' %}selected{% endif %}>3 days</option>
                                <option value="7" {% if max_days_old == '7' %}selected{% endif %}>1 week</option>
                                <option value="14" {% if max_days_old == '14' %}selected{% endif %}>2 weeks</option>
                                <option value="30" {% if max_days_old == '30' or not max_days_old %}selected{% endif %}>30 days</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="remoteOnly" {% if remote_only %}checked{% endif %}>
                                <label class="form-check-label" for="remoteOnly">
                                    Remote Jobs Only
                                </label>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="startJobSync()">
                        <i class="fas fa-sync me-1"></i> Sync Jobs
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Job Details Modal -->
        <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="jobDetailsModalLabel">Job Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="jobDetails"></div>
                    </div>
                    <div class="modal-footer">
                        <a href="#" id="jobApplyLink" target="_blank" class="btn btn-success">
                            <i class="fas fa-external-link-alt me-1"></i> View Job
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="bg-dark text-center text-white p-3 mt-5">
            <div class="container">
                <p class="mb-0">© 2025 AI Job Matcher | Powered by Adzuna API</p>
            </div>
        </footer>

        <!-- Bootstrap JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- DataTables -->
        <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

        <script>
            $(document).ready(function() {
                // Initialize DataTables
                try {
                    // Configure DataTables options
                    const dtOptions = {
                        pageLength: 10,
                        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        order: [[6, 'desc']], // Sort by match percentage column (7th column, 0-indexed)
                        columnDefs: [
                            { targets: 6, type: 'num' } // Treat Match % column as numeric
                        ],
                        // Add responsive handling
                        responsive: true,
                        language: {
                            emptyTable: "No job listings available"
                        }
                    };
                    
                    // Function to safely initialize a DataTable
                    function initDataTable(tableId) {
                        // Check if table exists in DOM
                        const table = $(tableId);
                        if (table.length === 0) return;
                        
                        // Destroy existing DataTable if it exists
                        if ($.fn.DataTable.isDataTable(tableId)) {
                            table.DataTable().destroy();
                        }
                        
                        // Initialize DataTable (even for empty tables to show proper message)
                        const dt = table.DataTable(dtOptions);
                        
                        // Log initialization
                        console.log(`${tableId} DataTable initialized with ${table.find('tbody tr').length} rows`);
                        
                        return dt;
                    }
                    
                    // Initialize all tables
                    initDataTable('#jobsTable');
                    initDataTable('#recentJobsTable');
                    initDataTable('#remoteJobsTable');
                } catch (e) {
                    console.error("Error initializing DataTables:", e);
                }
                
                // Job details modal
                $('.view-job').click(function() {
                    const jobId = $(this).data('job-id');
                    showJobDetails(jobId);
                });
                
                // Toggle collapsible job details
                $('.toggle-job-details').click(function() {
                    const jobId = $(this).data('job-id');
                    const detailsRow = $(`#job-details-${jobId}`);
                    
                    // Toggle the details row
                    if (detailsRow.hasClass('d-none')) {
                        // Hide any other open details first
                        $('.job-details-row').not(detailsRow).addClass('d-none');
                        // Show this one
                        detailsRow.removeClass('d-none');
                        $(this).html('<i class="fas fa-eye-slash"></i> Hide');
                    } else {
                        // Hide this one
                        detailsRow.addClass('d-none');
                        $(this).html('<i class="fas fa-eye"></i> View');
                    }
                });
            });
            
            // Show job details in modal
            function showJobDetails(jobId) {
                // Get the job from the correct table
                let job;
                let activeTab = $('.nav-tabs .active').attr('id');
                
                // Initialize global job data variables for each tab
                var allJobs = {{ jobs|default({})|tojson }};
                var recentJobs = {{ recent_jobs_list|default({})|tojson }};
                var remoteJobs = {{ remote_jobs_list|default({})|tojson }};
                
                if (activeTab === 'all-jobs-tab') {
                    job = allJobs;
                } else if (activeTab === 'recent-tab') {
                    job = recentJobs;
                } else if (activeTab === 'remote-tab') {
                    job = remoteJobs;
                }
                
                if (!job || !job[jobId]) {
                    $('#jobDetails').html('<div class="alert alert-danger">Job details not found.</div>');
                    return;
                }
                
                job = job[jobId];
                
                const detailsHtml = `
                    <div class="mb-4">
                        <h3>${job.title}</h3>
                        <p class="text-muted">${job.company} • ${job.location} • ${job.is_remote ? '<span class="badge bg-success">Remote</span>' : ''}</p>
                        ${job.salary_range ? `<p class="badge bg-info">${job.salary_range}</p>` : ''}
                        <p class="text-muted">Posted: ${job.posted_date}</p>
                        ${job.match_percentage ? `<p class="badge bg-success">Match: ${job.match_percentage}%</p>` : ''}
                    </div>
                    
                    <h4>Job Description</h4>
                    <div class="mb-4 job-description">
                        ${job.description || 'No description available.'}
                    </div>
                    
                    ${job.skills && job.skills.length > 0 ? `
                    <h4>Skills</h4>
                    <div class="mb-4">
                        ${job.skills.map(skill => `<span class="badge bg-secondary me-1">${skill}</span>`).join('')}
                    </div>
                    ` : ''}
                `;
                
                $('#jobDetails').html(detailsHtml);
                $('#jobApplyLink').attr('href', job.url);
            }
            
            // Global variables for sync tracking
            let syncProgressInterval;
            let syncStartTime;
            
            // Start a new job sync
            function startJobSync() {
                // Get sync parameters from the form
                const keywords = $('#keywords').val();
                const location = $('#location').val();
                const country = $('#country').val();
                const maxPages = $('#maxPages').val() ? parseInt($('#maxPages').val()) : null;
                const maxDaysOld = parseInt($('#maxDaysOld').val());
                const remoteOnly = $('#remoteOnly').is(':checked');
                
                // Show status alert
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Syncing jobs... This may take a few minutes.');
                
                // Record start time
                syncStartTime = new Date();
                
                // Start the sync
                $.ajax({
                    url: '/api/adzuna/bulk-sync',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        keywords: keywords,
                        location: location,
                        country: country,
                        max_pages: maxPages,
                        max_days_old: maxDaysOld,
                        remote_only: remoteOnly
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> Job sync successfully started. Reload the page in a few minutes to see new jobs.`);
                            
                            // Reload after a delay to show the latest data
                            setTimeout(function() {
                                location.reload();
                            }, 30000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Legacy sync function for backward compatibility
            function syncJobsNow() {
                startJobSync();
            }
            
            // Import to main storage
            function importToMainStorage() {
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Importing jobs to main storage...');
                
                $.ajax({
                    url: '/api/adzuna/import',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        days: 30
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> ${response.jobs_imported} jobs imported to main storage.`);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Clean up old jobs
            function cleanupOldJobs() {
                if (!confirm('This will remove jobs older than 90 days. Continue?')) {
                    return;
                }
                
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Cleaning up old jobs...');
                
                $.ajax({
                    url: '/api/adzuna/cleanup',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        max_age: 90
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> ${response.jobs_removed} old jobs removed.`);
                            
                            // Reload after a delay
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Export jobs
            function exportJobs() {
                // Simple export to CSV
                alert('Export feature to be implemented.');
            }
        </script>
</body>
</html>
