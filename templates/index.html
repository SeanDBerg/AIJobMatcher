<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Matcher Dashboard</title>
    <!-- Bootstrap CSS (Replit-themed) -->
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
</head>
<body>
    <div class="container-fluid mt-3">
        <h2 class="mb-3"><i class="fas fa-search me-2"></i>AI Job Matcher</h1>
        
        <!-- Alert Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Upload Resume Section -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_resume') }}" enctype="multipart/form-data" class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="resume" class="form-label">Upload Resume (PDF, DOCX, or TXT)</label>
                            <input class="form-control" type="file" id="resume" name="resume" accept=".pdf,.docx,.txt" required>
                        </div>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-upload me-1"></i> Upload Resume & Find Matches
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main Dashboard Section -->
        <div class="row mb-4">
            <!-- Left Column: Stats -->
            <div class="col-md-8">
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Total Jobs</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ total_jobs|default('0') }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-briefcase fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Last 7 Days</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ recent_jobs|default('0') }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-calendar-week fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                            Last Sync</div>
                                        <div class="h5 mb-0 font-weight-bold">{{ last_sync|default('Never') }}</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-sync fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                            Sync Method</div>
                                        <div class="h5 mb-0 font-weight-bold">Manual Only</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-sync fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Resume History -->
            <div class="col-md-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold">Resume History</h6>
                    </div>
                    <div class="card-body">
                        {% if stored_resumes %}
                            <div class="list-group">
                                {% for resume in stored_resumes %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="#" data-resume-id="{{ resume.id }}" class="resume-select-link text-decoration-none">
                                            <div>
                                                <span>{{ resume.filename }}</span>
                                                <small class="d-block text-muted">{{ resume.upload_date }}</small>
                                            </div>
                                        </a>
                                        <form action="{{ url_for('delete_resume', resume_id=resume.id) }}" method="POST" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                No resumes uploaded yet. Use the form above to upload your resume.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Job Listings Section -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold">Job Listings</h6>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="jobActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw"></i> Actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="jobActionsDropdown">
                        <li><a class="dropdown-item" href="#" onclick="exportJobs()">
                            <i class="fas fa-download fa-sm fa-fw me-2 text-gray-400"></i>
                            Export Jobs
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="importToMainStorage()">
                            <i class="fas fa-database fa-sm fa-fw me-2 text-gray-400"></i>
                            Import to Main Storage
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="cleanupOldJobs()">
                            <i class="fas fa-trash fa-sm fa-fw me-2 text-gray-400"></i>
                            Clean Up Old Jobs
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="jobsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-jobs-tab" data-bs-toggle="tab" data-bs-target="#all-jobs" type="button" role="tab" aria-controls="all-jobs" aria-selected="true">All Jobs</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="recent-tab" data-bs-toggle="tab" data-bs-target="#recent" type="button" role="tab" aria-controls="recent" aria-selected="false">Recent (7 Days)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="remote-tab" data-bs-toggle="tab" data-bs-target="#remote" type="button" role="tab" aria-controls="remote" aria-selected="false">Remote Only</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="batch-summary-tab" data-bs-toggle="tab" data-bs-target="#batch-summary" type="button" role="tab" aria-controls="batch-summary" aria-selected="false">Batch Summary</button>
                    </li>
                </ul>
                <div class="tab-content mt-4" id="jobsTabContent">
                    <div class="tab-pane fade show active" id="all-jobs" role="tabpanel" aria-labelledby="all-jobs-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered job-table" id="jobsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Company</th>
                                        <th>Location</th>
                                        <th>Remote</th>
                                        <th>Date Posted</th>
                                        <th>Salary</th>
                                        <th>Match %</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if jobs %}
                                        {% for job_id, job in jobs.items() %}
                                            <tr class="job-row" data-job-id="{{ job_id }}">
                                                <td>{{ job.title }}</td>
                                                <td>{{ job.company }}</td>
                                                <td>{{ job.location }}</td>
                                                <td>{{ 'Yes' if job.is_remote else 'No' }}</td>
                                                <td>{{ job.posted_date }}</td>
                                                <td>{{ job.salary_range|default('Not specified') }}</td>
                                                <td>{{ (job.match_percentage|string ~ '%') if job.match_percentage is not none else '0%' }}</td>

                                                <td>
                                                    <button class="btn btn-sm btn-outline-info toggle-job-details" data-job-id="{{ job_id }}">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Visit Job Listing">
                                                        <i class="fas fa-external-link-alt"></i> Apply
                                                    </a>
                                                </td>
                                            </tr>
                                            <!-- Collapsible job description row -->
                                            <tr class="job-details-row d-none" id="job-details-{{ job_id }}">
                                                <td colspan="8">
                                                    <div class="job-details-content p-3">
                                                        <h5>{{ job.title }} at {{ job.company }}</h5>
                                                        {% if job.skills %}
                                                            <div class="mb-3">
                                                                <strong>Skills:</strong>
                                                                <div class="mt-1">
                                                                    {% for skill in job.skills %}
                                                                        <span class="badge bg-secondary me-1 mb-1">{{ skill }}</span>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        <div class="mb-3">
                                                            <strong>Description:</strong>
                                                            <div class="job-description mt-2">
                                                                {{ job.description|safe }}
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <a href="{{ job.url }}" target="_blank" class="btn btn-primary">
                                                                <i class="fas fa-external-link-alt me-1"></i> Apply for This Position
                                                            </a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="8" class="text-center">No jobs found. <a href="#" onclick="syncJobsNow()">Sync jobs now</a>.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="recent" role="tabpanel" aria-labelledby="recent-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered job-table" id="recentJobsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Company</th>
                                        <th>Location</th>
                                        <th>Remote</th>
                                        <th>Date Posted</th>
                                        <th>Salary</th>
                                        <th>Match %</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if recent_jobs_list %}
                                        {% for job_id, job in recent_jobs_list.items() %}
                                            <tr class="job-row" data-job-id="recent-{{ job_id }}">
                                                <td>{{ job.title }}</td>
                                                <td>{{ job.company }}</td>
                                                <td>{{ job.location }}</td>
                                                <td>{{ 'Yes' if job.is_remote else 'No' }}</td>
                                                <td>{{ job.posted_date }}</td>
                                                <td>{{ job.salary_range|default('Not specified') }}</td>
                                                <td>{{ (job.match_percentage|string ~ '%') if job.match_percentage is not none else '0%' }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-info toggle-job-details" data-job-id="recent-{{ job_id }}">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Visit Job Listing">
                                                        <i class="fas fa-external-link-alt"></i> Apply
                                                    </a>
                                                </td>
                                            </tr>
                                            <!-- Collapsible job description row -->
                                            <tr class="job-details-row d-none" id="job-details-recent-{{ job_id }}">
                                                <td colspan="8">
                                                    <div class="job-details-content p-3">
                                                        <h5>{{ job.title }} at {{ job.company }}</h5>
                                                        {% if job.skills %}
                                                            <div class="mb-3">
                                                                <strong>Skills:</strong>
                                                                <div class="mt-1">
                                                                    {% for skill in job.skills %}
                                                                        <span class="badge bg-secondary me-1 mb-1">{{ skill }}</span>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        <div class="mb-3">
                                                            <strong>Description:</strong>
                                                            <div class="job-description mt-2">
                                                                {{ job.description|safe }}
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <a href="{{ job.url }}" target="_blank" class="btn btn-primary">
                                                                <i class="fas fa-external-link-alt me-1"></i> Apply for This Position
                                                            </a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="8" class="text-center">No recent jobs found.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="remote" role="tabpanel" aria-labelledby="remote-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered job-table" id="remoteJobsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Company</th>
                                        <th>Location</th>
                                        <th>Date Posted</th>
                                        <th>Salary</th>
                                        <th>Match %</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if remote_jobs_list %}
                                        {% for job_id, job in remote_jobs_list.items() %}
                                            <tr class="job-row" data-job-id="remote-{{ job_id }}">
                                                <td>{{ job.title }}</td>
                                                <td>{{ job.company }}</td>
                                                <td>{{ job.location }}</td>
                                                <td>{{ job.posted_date }}</td>
                                                <td>{{ job.salary_range|default('Not specified') }}</td>
                                                <td>{{ (job.match_percentage|string ~ '%') if job.match_percentage is not none else '0%' }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-info toggle-job-details" data-job-id="remote-{{ job_id }}">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Visit Job Listing">
                                                        <i class="fas fa-external-link-alt"></i> Apply
                                                    </a>
                                                </td>
                                            </tr>
                                            <!-- Collapsible job description row -->
                                            <tr class="job-details-row d-none" id="job-details-remote-{{ job_id }}">
                                                <td colspan="7">
                                                    <div class="job-details-content p-3">
                                                        <h5>{{ job.title }} at {{ job.company }}</h5>
                                                        {% if job.skills %}
                                                            <div class="mb-3">
                                                                <strong>Skills:</strong>
                                                                <div class="mt-1">
                                                                    {% for skill in job.skills %}
                                                                        <span class="badge bg-secondary me-1 mb-1">{{ skill }}</span>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        <div class="mb-3">
                                                            <strong>Description:</strong>
                                                            <div class="job-description mt-2">
                                                                {{ job.description|safe }}
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <a href="{{ job.url }}" target="_blank" class="btn btn-primary">
                                                                <i class="fas fa-external-link-alt me-1"></i> Apply for This Position
                                                            </a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="7" class="text-center">No remote jobs found.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="batch-summary" role="tabpanel" aria-labelledby="batch-summary-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered job-table" id="batchSummaryTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Batch ID</th>
                                        <th>Timestamp</th>
                                        <th>Job Count</th>
                                        <th>Keywords</th>
                                        <th>Location</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if storage_status and storage_status.get('batches') %}
                                        {% for batch_id, batch_info in storage_status.get('batches').items() %}
                                            <tr>
                                                <td>{{ batch_id }}</td>
                                                <td>{{ batch_info.timestamp }}</td>
                                                <td>{{ batch_info.job_count }}</td>
                                                <td>{{ batch_info.keywords|default('') }}</td>
                                                <td>{{ batch_info.location|default('') }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-danger delete-batch" data-batch-id="{{ batch_id }}">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center">No batches found.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sync Status Alert -->
        <div class="alert alert-info alert-dismissible fade show mb-4" id="syncStatus" style="display: none;" role="alert">
            <span id="syncStatusText">Syncing jobs...</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <!-- Job Source Settings (moved from Settings page) -->
        <div id="jobSourceSettings" class="card-body pb-0 border-bottom">
            <div class="row">
                <div class="col-lg-9">
                    <h6 class="mb-3">Job Search Parameters</h6>
                    <form id="jobSearchForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="country" class="form-label">Country</label>
                            <select class="form-select" id="country" name="country">
                                <option value="gb" {% if not country or country == 'gb' %}selected{% endif %}>United Kingdom (gb)</option>
                                <option value="us" {% if country == 'us' %}selected{% endif %}>United States (us)</option>
                                <option value="ca" {% if country == 'ca' %}selected{% endif %}>Canada (ca)</option>
                                <option value="de" {% if country == 'de' %}selected{% endif %}>Germany (de)</option>
                                <option value="fr" {% if country == 'fr' %}selected{% endif %}>France (fr)</option>
                                <option value="au" {% if country == 'au' %}selected{% endif %}>Australia (au)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" value="{{ location|default('') }}" placeholder="e.g., London, New York">
                        </div>
                        <div class="col-md-4">
                            <label for="keywords" class="form-label">Keywords</label>
                            <input type="text" class="form-control" id="keywords" name="keywords" value="{{ keywords|default('') }}" placeholder="e.g., Python Developer">
                        </div>
                        <div class="col-md-3">
                            <label for="max_days_old" class="form-label">Max Days Old</label>
                            <select class="form-select" id="max_days_old" name="max_days_old">
                                <option value="1" {% if max_days_old == 1 %}selected{% endif %}>1 day</option>
                                <option value="3" {% if max_days_old == 3 %}selected{% endif %}>3 days</option>
                                <option value="7" {% if max_days_old == 7 %}selected{% endif %}>1 week</option>
                                <option value="14" {% if max_days_old == 14 %}selected{% endif %}>2 weeks</option>
                                <option value="30" {% if not max_days_old or max_days_old == 30 %}selected{% endif %}>30 days</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="maxPages" class="form-label">Max Pages</label>
                            <input type="number" class="form-control" id="maxPages" name="max_pages" value="{{ max_pages|default('5') }}" min="1" max="20">
                            <small class="text-muted">1-20 pages (50 jobs per page)</small>
                        </div>
                        <div class="col-md-3">
                            <div class="mt-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="remote_only" name="remote_only" value="1" {% if remote_only %}checked{% endif %}>
                                    <label class="form-check-label" for="remote_only">
                                        Remote Jobs Only
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Scheduler UI elements removed -->
                        <div class="col-12 mt-2">
                            <button type="button" class="btn btn-primary" onclick="saveJobSearch()">
                                <i class="fas fa-save me-1"></i> Save Settings
                            </button>
                            <button type="button" class="btn btn-success ms-2" onclick="syncJobs()">
                                <i class="fas fa-sync-alt me-1"></i> Sync Jobs
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Job Details Modal -->
        <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="jobDetailsModalLabel">Job Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="jobDetails"></div>
                    </div>
                    <div class="modal-footer">
                        <a href="#" id="jobApplyLink" target="_blank" class="btn btn-success">
                            <i class="fas fa-external-link-alt me-1"></i> View Job
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="bg-dark text-center text-white p-3 mt-5">
            <div class="container">
                <p class="mb-0">© 2025 AI Job Matcher | Powered by Adzuna API</p>
            </div>
        </footer>

        <!-- Bootstrap JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- DataTables -->
        <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

        <script>
            // Global variables to store current tables and jobs data
            let jobTables = {};
            let currentResumeId = null;

            // Initialize everything when document is ready
            $(document).ready(function() {
                // Add event handler for batch deletion
                $(document).on('click', '.delete-batch', function() {
                    const batchId = $(this).data('batch-id');
                    if (confirm('Are you sure you want to delete this batch? This action cannot be undone.')) {
                        deleteBatch(batchId);
                    }
                });
                // Load saved job search parameters if available
                if (localStorage.getItem('job_search_keywords')) {
                    $('#keywords').val(localStorage.getItem('job_search_keywords'));
                }
                if (localStorage.getItem('job_search_location')) {
                    $('#location').val(localStorage.getItem('job_search_location'));
                }
                if (localStorage.getItem('job_search_country')) {
                    $('#country').val(localStorage.getItem('job_search_country'));
                }
                if (localStorage.getItem('job_search_max_days_old')) {
                    $('#max_days_old').val(localStorage.getItem('job_search_max_days_old'));
                }
                if (localStorage.getItem('job_search_remote_only') === '1') {
                    $('#remote_only').prop('checked', true);
                }
                if (localStorage.getItem('job_search_max_pages')) {
                    $('#maxPages').val(localStorage.getItem('job_search_max_pages'));
                }
                
                // Check for active resume ID in URL query parameters
                const urlParams = new URLSearchParams(window.location.search);
                const activeResumeId = urlParams.get('active_resume_id');
                
                if (activeResumeId) {
                    // Find and activate the resume with the matching ID
                    const resumeLink = $(`.resume-select-link[data-resume-id="${activeResumeId}"]`);
                    if (resumeLink.length) {
                        // Update active class
                        $('.resume-select-link').removeClass('active');
                        resumeLink.addClass('active');
                        currentResumeId = activeResumeId;
                        
                        // Wait for tables to initialize before matching
                        setTimeout(function() {
                            // Call API to match resume
                            getJobMatchesForResume(activeResumeId);
                        }, 1000);
                    }
                } else if ($('.resume-select-link').length) {
                    // No active resume specified - select first resume by default if available
                    $('.resume-select-link').first().addClass('active');
                    currentResumeId = $('.resume-select-link').first().data('resume-id');
                }
                
                // Handle resume selection
                $('.resume-select-link').click(function(e) {
                    e.preventDefault();
                    
                    // Update active class
                    $('.resume-select-link').removeClass('active');
                    $(this).addClass('active');
                    
                    // Get resume ID
                    const resumeId = $(this).data('resume-id');
                    currentResumeId = resumeId;
                    
                    // Show loading indicator
                    $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                    $('#syncStatusText').text('Matching resume to jobs...');
                    
                    // Call API to match resume
                    getJobMatchesForResume(resumeId);
                    
                    // Update URL without page reload to reflect the active resume
                    // This allows for bookmarking/sharing
                    const url = new URL(window.location);
                    url.searchParams.set('active_resume_id', resumeId);
                    window.history.pushState({}, '', url);
                });
                
                // Wait for DOM to be fully loaded before initializing tables
                initializeJobTables();
                
                // Job details modal
                $('.view-job').click(function() {
                    const jobId = $(this).data('job-id');
                    showJobDetails(jobId);
                });
                
                // Toggle collapsible job details
                $('.toggle-job-details').click(function() {
                    const jobId = $(this).data('job-id');
                    const detailsRow = $(`#job-details-${jobId}`);
                    
                    // Toggle the details row
                    if (detailsRow.hasClass('d-none')) {
                        // Hide any other open details first
                        $('.job-details-row').not(detailsRow).addClass('d-none');
                        // Show this one
                        detailsRow.removeClass('d-none');
                        $(this).html('<i class="fas fa-eye-slash"></i> Hide');
                    } else {
                        // Hide this one
                        detailsRow.addClass('d-none');
                        $(this).html('<i class="fas fa-eye"></i> View');
                    }
                });
            });
            
            // Show job details in modal
            function showJobDetails(jobId) {
                // Get the job from the correct table
                let job;
                let activeTab = $('.nav-tabs .active').attr('id');
                
                // Initialize global job data variables for each tab
                var allJobs = {{ jobs|default({})|tojson }};
                var recentJobs = {{ recent_jobs_list|default({})|tojson }};
                var remoteJobs = {{ remote_jobs_list|default({})|tojson }};
                
                if (activeTab === 'all-jobs-tab') {
                    job = allJobs;
                } else if (activeTab === 'recent-tab') {
                    job = recentJobs;
                } else if (activeTab === 'remote-tab') {
                    job = remoteJobs;
                }
                
                if (!job || !job[jobId]) {
                    $('#jobDetails').html('<div class="alert alert-danger">Job details not found.</div>');
                    return;
                }
                
                job = job[jobId];
                
                const detailsHtml = `
                    <div class="mb-4">
                        <h3>${job.title}</h3>
                        <p class="text-muted">${job.company} • ${job.location} • ${job.is_remote ? '<span class="badge bg-success">Remote</span>' : ''}</p>
                        ${job.salary_range ? `<p class="badge bg-info">${job.salary_range}</p>` : ''}
                        <p class="text-muted">Posted: ${job.posted_date}</p>
                        ${job.match_percentage ? `<p class="badge bg-success">Match: ${job.match_percentage}%</p>` : ''}
                    </div>
                    
                    <h4>Job Description</h4>
                    <div class="mb-4 job-description">
                        ${job.description || 'No description available.'}
                    </div>
                    
                    ${job.skills && job.skills.length > 0 ? `
                    <h4>Skills</h4>
                    <div class="mb-4">
                        ${job.skills.map(skill => `<span class="badge bg-secondary me-1">${skill}</span>`).join('')}
                    </div>
                    ` : ''}
                `;
                
                $('#jobDetails').html(detailsHtml);
                $('#jobApplyLink').attr('href', job.url);
            }
            
            // Global variables for sync tracking
            let syncProgressInterval;
            let syncStartTime;
            
            // Function to sync jobs from Adzuna
            function syncJobs() {
                // Get sync parameters from the Job Search Parameters form
                const keywords = $('#keywords').val();
                const location = $('#location').val();
                const country = $('#country').val();
                const maxPages = $('#maxPages').val() ? parseInt($('#maxPages').val()) : 5;
                const maxDaysOld = parseInt($('#max_days_old').val());
                const remoteOnly = $('#remote_only').is(':checked');
                
                // Save settings first
                saveJobSearch();
                
                // Show status alert
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Syncing jobs... This may take a few minutes.');
                
                // Record start time
                syncStartTime = new Date();
                
                // Start the sync
                $.ajax({
                    url: '/api/jobs/sync',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        keywords: keywords,
                        location: location,
                        country: country,
                        max_pages: maxPages,
                        max_days_old: maxDaysOld,
                        remote_only: remoteOnly
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> Job sync successfully started. Reload the page in a few minutes to see new jobs.`);
                            
                            // Reload after a delay to show the latest data
                            setTimeout(function() {
                                location.reload();
                            }, 30000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Import to main storage
            function importToMainStorage() {
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Importing jobs to main storage...');
                
                $.ajax({
                    url: '/api/adzuna/import',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        days: 30
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> ${response.jobs_imported} jobs imported to main storage.`);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Clean up old jobs
            function cleanupOldJobs() {
                if (!confirm('This will remove jobs older than 90 days. Continue?')) {
                    return;
                }
                
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Cleaning up old jobs...');
                
                $.ajax({
                    url: '/api/adzuna/cleanup',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        max_age: 90
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> ${response.jobs_removed} old jobs removed.`);
                            
                            // Reload after a delay
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Save job search parameters
            function saveJobSearch() {
                // Get form values
                const keywords = $('#keywords').val();
                const location = $('#location').val();
                const country = $('#country').val();
                const maxDaysOld = $('#max_days_old').val();
                const remoteOnly = $('#remote_only').is(':checked') ? '1' : '';
                const maxPages = $('#maxPages').val();
                
                // Store values in session/browser storage for persistence
                localStorage.setItem('job_search_keywords', keywords);
                localStorage.setItem('job_search_location', location);
                localStorage.setItem('job_search_country', country);
                localStorage.setItem('job_search_max_days_old', maxDaysOld);
                localStorage.setItem('job_search_remote_only', remoteOnly);
                localStorage.setItem('job_search_max_pages', maxPages);
                
                // Show confirmation message
                $('#syncStatus').show().removeClass('alert-info alert-danger').addClass('alert-success');
                $('#syncStatusText').html('<i class="fas fa-check-circle"></i> Settings saved successfully.');
                
                // Auto-hide after a few seconds
                setTimeout(function() {
                    $('#syncStatus').fadeOut();
                }, 3000);
            }
            
            // Export jobs
            function exportJobs() {
                // Simple export to CSV
                alert('Export feature to be implemented.');
            }
            
            // Initialize job tables with proper configuration
            // Function to delete a batch
            function deleteBatch(batchId) {
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Deleting batch...');
                
                $.ajax({
                    url: `/api/adzuna/batch/${batchId}`,
                    method: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> Batch deleted successfully.`);
                            
                            // Remove the row from the table
                            $(`button.delete-batch[data-batch-id="${batchId}"]`).closest('tr').remove();
                            
                            // Reload the page after a short delay to refresh the data
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            function initializeJobTables() {
                try {
                    // Wait for the DOM to be fully ready
                    $(document).ready(function() {
                        // Super basic configuration - minimum features to ensure it works
                        const tableConfig = {
                            pageLength: 10,
                            order: [[6, 'desc']], // Sort by match percentage column by default
                            processing: true,
                            retrieve: true, // Allow the table to be retrieved again
                            columnDefs: [
                                {
                                    targets: 6, // Match percentage column
                                    render: function(data, type, row) {
                                        if (type === 'sort' || type === 'type') {
                                            // Extract numeric part for sorting
                                            return parseFloat(data) || 0;
                                        }
                                        return data;
                                    }
                                }
                            ]
                        };
                        
                        // Initialize all tables with a delay to ensure DOM is ready
                        setTimeout(function() {
                            $('.job-table').each(function() {
                                // Skip if table has no rows besides the empty message
                                if ($(this).find('tbody tr').length === 0 || 
                                    ($(this).find('tbody tr').length === 1 && 
                                     $(this).find('tbody tr:first td').length === 1) ||
                                    ($(this).find('tbody tr:first td:first').text().trim() === 'No jobs found' ||
                                     $(this).find('tbody tr:first td:first').text().trim() === 'No recent jobs found' ||
                                     $(this).find('tbody tr:first td:first').text().trim() === 'No remote jobs found' ||
                                     $(this).find('tbody tr:first td:first').text().trim() === 'No data available')) {
                                    console.log("Skipping empty table:", $(this).attr('id'));
                                    return;
                                }
                                
                                try {
                                    const tableId = '#' + $(this).attr('id');
                                    
                                    // Destroy existing table if it exists
                                    if ($.fn.DataTable.isDataTable(tableId)) {
                                        $(tableId).DataTable().destroy();
                                    }
                                    
                                    // Check if table has a header row
                                    if ($(tableId + ' thead tr th').length === 0) {
                                        console.log("Table has no header row:", tableId);
                                        return;
                                    }
                                    
                                    // Create new table with safer configuration and error handling
                                    try {
                                        const table = $(tableId).DataTable({
                                            ...tableConfig,
                                            // Handle errors gracefully
                                            language: {
                                                emptyTable: "No job data available"
                                            }
                                        });
                                        jobTables[tableId] = table;
                                        console.log("Table initialized:", tableId);
                                    } catch (dtError) {
                                        console.error("DataTables initialization error:", dtError);
                                    }
                                } catch (tableError) {
                                    console.error("Error initializing table:", $(this).attr('id'), tableError);
                                }
                            });
                        });
                        
                        // If a resume is already selected, match jobs
                        if (currentResumeId) {
                            getJobMatchesForResume(currentResumeId);
                        }
                        
                        console.log("Tables initialization complete");
                    }, 500);
                } catch (error) {
                    console.error("Error in table initialization function:", error);
                }
            }
            
            // Get job matches for a selected resume
            function getJobMatchesForResume(resumeId) {
                // Show loading indicator
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').html('<i class="fas fa-spinner fa-spin"></i> Matching resume to jobs...');
                
                $.ajax({
                    url: '/api/match-jobs',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        resume_id: resumeId
                    }),
                    success: function(response) {
                        if (response.success) {
                            // Update job match percentages in tables
                            updateJobMatchPercentages(response.matches);
                            
                            // Show success message
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> Resume matched to ${Object.keys(response.matches).length} jobs successfully.`);
                            
                            // Auto-hide message after a delay
                            setTimeout(function() {
                                $('#syncStatus').fadeOut();
                            }, 3000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Update job match percentages in tables
            function updateJobMatchPercentages(matches) {
                console.log("Updating job match percentages with matches:", matches);

                $('.job-table').each(function() {
                    const tableId = '#' + $(this).attr('id');

                    if (!$.fn.DataTable.isDataTable(tableId)) {
                        console.log("Table not initialized:", tableId);
                        return;
                    }

                    const table = $(tableId).DataTable();
                    let updatedRows = 0;

                    $(tableId + ' tbody tr.job-row').each(function() {
                        const jobRow = $(this);
                        const jobId = jobRow.data('job-id');

                        let matchFound = false;
                        let matchPercentage = 0;

                        if (matches[jobId]) {
                            matchPercentage = matches[jobId];
                            matchFound = true;
                        } else if (jobId && typeof jobId === 'string' && jobId.includes('-')) {
                            const baseJobId = jobId.split('-')[1];
                            if (matches[baseJobId]) {
                                matchPercentage = matches[baseJobId];
                                matchFound = true;
                            }
                        } else if (jobId && matches[String(jobId)]) {
                            matchPercentage = matches[String(jobId)];
                            matchFound = true;
                        }

                        if (matchFound) {
                            updatedRows++;
                            const formattedMatch = matchPercentage + '%';

                            // Update match % explicitly using DataTables API
                            const cell = table.cell(jobRow.find('td:eq(6)'));
                            cell.data(formattedMatch);
                        }
                    });

                    console.log(`Updated ${updatedRows} rows in table ${tableId}`);

                    // Redraw explicitly after updating all rows
                    if (updatedRows > 0) {
                        try {
                            table.order([6, 'desc']).draw(false);
                        } catch (sortError) {
                            console.error("Error sorting table:", sortError);
                        }
                    }
                });
            }
        </script>
</body>
</html>
