<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Matcher Dashboard</title>
    <!-- Bootstrap CSS (Replit-themed) -->
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
</head>
<body>
    <div class="container-fluid mt-3">
        <h2 class="mb-3"><i class="fas fa-search me-2"></i>AI Job Matcher</h1>
        
        <!-- Alert Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% include 'resume/resumeSection.html' %}
        {% include 'jobs/jobSection.html' %}
        {% include 'jobs/tableSection.html' %}        
        {% include 'sync/syncSection.html' %}        

        <!-- Job Details Modal -->
        <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="jobDetailsModalLabel">Job Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="jobDetails"></div>
                    </div>
                    <div class="modal-footer">
                        <a href="#" id="jobApplyLink" target="_blank" class="btn btn-success">
                            <i class="fas fa-external-link-alt me-1"></i> View Job
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="bg-dark text-center text-white p-3 mt-5">
            <div class="container">
                <p class="mb-0">© 2025 AI Job Matcher | Powered by Adzuna API</p>
            </div>
        </footer>

        <!-- Bootstrap JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- DataTables -->
        <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

        <script>
            // Global variables to store current tables and jobs data
            let jobTables = {};
            let currentResumeId = null;

            // Initialize everything when document is ready
            $(document).ready(function() {
                // Initialize keywords list
                let keywordsList = [];
                try {
                    // Try to load from the hidden input
                    const savedKeywords = $('#keywordsListData').val();
                    if (savedKeywords) {
                        keywordsList = JSON.parse(savedKeywords);
                        // Render the keywords
                        renderKeywords();
                    }
                } catch (e) {
                    console.error("Error loading keywords list:", e);
                }
                
                // Load keywords from localStorage if available
                if (localStorage.getItem('job_search_keywords_list')) {
                    try {
                        keywordsList = JSON.parse(localStorage.getItem('job_search_keywords_list'));
                        renderKeywords();
                    } catch (e) {
                        console.error("Error parsing keywords from localStorage:", e);
                    }
                }
                
                // Add keyword button click handler
                $('#addKeywordBtn').click(function() {
                    addKeyword();
                });
                
                // Keywords input enter key press handler
                $('#keywords').keypress(function(e) {
                    if (e.which === 13) { // Enter key
                        e.preventDefault();
                        addKeyword();
                    }
                });
                
                // Function to add keyword from input
                function addKeyword() {
                    const keyword = $('#keywords').val().trim();
                    if (keyword) {
                        if (!keywordsList.includes(keyword)) {
                            keywordsList.push(keyword);
                            renderKeywords();
                            $('#keywords').val(''); // Clear input
                            
                            // Save to localStorage
                            localStorage.setItem('job_search_keywords_list', JSON.stringify(keywordsList));
                            
                            // Also save to server session
                            saveKeywordsListToServer(keywordsList);
                        } else {
                            // Show message that keyword already exists
                            $('#syncStatus').show().removeClass('alert-success alert-info').addClass('alert-warning');
                            $('#syncStatusText').html('<i class="fas fa-exclamation-triangle"></i> Keyword already in list.');
                            
                            // Auto-hide after a few seconds
                            setTimeout(function() {
                                $('#syncStatus').fadeOut();
                            }, 3000);
                        }
                    }
                }
                
                // Function to render keywords
                function renderKeywords() {
                    const $container = $('#keywordsList');
                    $container.empty();
                    
                    if (keywordsList.length > 0) {
                        keywordsList.forEach((keyword, index) => {
                            const $keyword = $(`
                                <div class="badge bg-primary me-2 mb-2 p-2">
                                    ${keyword}
                                    <button type="button" class="btn-close btn-close-white ms-2" 
                                            aria-label="Remove" data-index="${index}"></button>
                                </div>
                            `);
                            $container.append($keyword);
                        });
                        
                        // Update hidden input with JSON data
                        $('#keywordsListData').val(JSON.stringify(keywordsList));
                    }
                }
                
                // Keyword delete button handler
                $(document).on('click', '#keywordsList .btn-close', function() {
                    const index = $(this).data('index');
                    keywordsList.splice(index, 1);
                    renderKeywords();
                    
                    // Save to localStorage
                    localStorage.setItem('job_search_keywords_list', JSON.stringify(keywordsList));
                    
                    // Also save to server session for persistence
                    saveKeywordsListToServer(keywordsList);
                });
                
                // Function to save keywords list to server
                function saveKeywordsListToServer(keywordsList) {
                    $.ajax({
                        url: '/api/save_keywords_list',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            keywords_list: keywordsList
                        }),
                        success: function(response) {
                            if (response.success) {
                                console.log(`Saved ${response.count} keywords to server session`);
                            } else {
                                console.error('Error saving keywords list:', response.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error saving keywords list to server:', error);
                        }
                    });
                }
                
                // Add event handler for batch deletion
                $(document).on('click', '.delete-batch', function() {
                    const batchId = $(this).data('batch-id');
                    if (confirm('Are you sure you want to delete this batch? This action cannot be undone.')) {
                        deleteBatch(batchId);
                    }
                });
                // Load saved job search parameters if available
                if (localStorage.getItem('job_search_keywords')) {
                    $('#keywords').val(localStorage.getItem('job_search_keywords'));
                }
                if (localStorage.getItem('job_search_location')) {
                    $('#location').val(localStorage.getItem('job_search_location'));
                }
                if (localStorage.getItem('job_search_country')) {
                    $('#country').val(localStorage.getItem('job_search_country'));
                }
                if (localStorage.getItem('job_search_max_days_old')) {
                    $('#max_days_old').val(localStorage.getItem('job_search_max_days_old'));
                }
                if (localStorage.getItem('job_search_remote_only') === '1') {
                    $('#remote_only').prop('checked', true);
                }
                if (localStorage.getItem('job_search_max_pages')) {
                    $('#maxPages').val(localStorage.getItem('job_search_max_pages'));
                }
                
                // Check for active resume ID in URL query parameters
                const urlParams = new URLSearchParams(window.location.search);
                const activeResumeId = urlParams.get('active_resume_id');
                
                if (activeResumeId) {
                    // Find and activate the resume with the matching ID
                    const resumeLink = $(`.resume-select-link[data-resume-id="${activeResumeId}"]`);
                    if (resumeLink.length) {
                        // Update active class
                        $('.resume-select-link').removeClass('active');
                        resumeLink.addClass('active');
                        currentResumeId = activeResumeId;
                        
                        // Wait for tables to initialize before matching
                        setTimeout(function() {
                            // Call API to match resume
                            getJobMatchesForResume(activeResumeId);
                        }, 1000);
                    }
                } else if ($('.resume-select-link').length) {
                    // No active resume specified - select first resume by default if available
                    $('.resume-select-link').first().addClass('active');
                    currentResumeId = $('.resume-select-link').first().data('resume-id');
                }
                
                // Handle resume selection
                $('.resume-select-link').click(function(e) {
                    e.preventDefault();
                    
                    // Update active class
                    $('.resume-select-link').removeClass('active');
                    $(this).addClass('active');
                    
                    // Get resume ID
                    const resumeId = $(this).data('resume-id');
                    currentResumeId = resumeId;
                    
                    // Show loading indicator
                    $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                    $('#syncStatusText').text('Matching resume to jobs...');
                    
                    // Call API to match resume
                    getJobMatchesForResume(resumeId);
                    
                    // Update URL without page reload to reflect the active resume
                    // This allows for bookmarking/sharing
                    const url = new URL(window.location);
                    url.searchParams.set('active_resume_id', resumeId);
                    window.history.pushState({}, '', url);
                });
                
                // Wait for DOM to be fully loaded before initializing tables
                initializeJobTables();
                
                // Job details modal
                $('.view-job').click(function() {
                    const jobId = $(this).data('job-id');
                    showJobDetails(jobId);
                });
                
                // Toggle collapsible job details
                $('.toggle-job-details').click(function() {
                    const jobId = $(this).data('job-id');
                    const detailsRow = $(`#job-details-${jobId}`);
                    
                    // Toggle the details row
                    if (detailsRow.hasClass('d-none')) {
                        // Hide any other open details first
                        $('.job-details-row').not(detailsRow).addClass('d-none');
                        // Show this one
                        detailsRow.removeClass('d-none');
                        $(this).html('<i class="fas fa-eye-slash"></i> Hide');
                    } else {
                        // Hide this one
                        detailsRow.addClass('d-none');
                        $(this).html('<i class="fas fa-eye"></i> View');
                    }
                });
            });
            
            // Show job details in modal
            function showJobDetails(jobId) {
                // Get the job from the correct table
                let job;
                let activeTab = $('.nav-tabs .active').attr('id');
                
                // Initialize global job data variables for each tab
                var allJobs = {{ jobs|default({})|tojson }};
                var recentJobs = {{ recent_jobs_list|default({})|tojson }};
                var remoteJobs = {{ remote_jobs_list|default({})|tojson }};
                
                if (activeTab === 'all-jobs-tab') {
                    job = allJobs;
                } else if (activeTab === 'recent-tab') {
                    job = recentJobs;
                } else if (activeTab === 'remote-tab') {
                    job = remoteJobs;
                }
                
                if (!job || !job[jobId]) {
                    $('#jobDetails').html('<div class="alert alert-danger">Job details not found.</div>');
                    return;
                }
                
                job = job[jobId];
                
                const detailsHtml = `
                    <div class="mb-4">
                        <h3>${job.title}</h3>
                        <p class="text-muted">${job.company} • ${job.location} • ${job.is_remote ? '<span class="badge bg-success">Remote</span>' : ''}</p>
                        ${job.salary_range ? `<p class="badge bg-info">${job.salary_range}</p>` : ''}
                        <p class="text-muted">Posted: ${job.posted_date}</p>
                        ${job.match_percentage ? `<p class="badge bg-success">Match: ${job.match_percentage}%</p>` : ''}
                    </div>
                    
                    <h4>Job Description</h4>
                    <div class="mb-4 job-description">
                        ${job.description || 'No description available.'}
                    </div>
                    
                    ${job.skills && job.skills.length > 0 ? `
                    <h4>Skills</h4>
                    <div class="mb-4">
                        ${job.skills.map(skill => `<span class="badge bg-secondary me-1">${skill}</span>`).join('')}
                    </div>
                    ` : ''}
                `;
                
                $('#jobDetails').html(detailsHtml);
                $('#jobApplyLink').attr('href', job.url);
            }
            
            // Global variables for sync tracking
            let syncProgressInterval;
            let syncStartTime;
            
            // Function to sync jobs from Adzuna
            function syncJobs() {
                // Get sync parameters from the Job Search Parameters form
                const keywords = $('#keywords').val();
                const keywordsList = [];
                
                // Try to get keywords list from hidden input
                try {
                    const keywordsListData = $('#keywordsListData').val();
                    if (keywordsListData) {
                        const parsedKeywords = JSON.parse(keywordsListData);
                        if (Array.isArray(parsedKeywords)) {
                            // Add all keywords in the list
                            parsedKeywords.forEach(kw => {
                                if (kw && !keywordsList.includes(kw)) {
                                    keywordsList.push(kw);
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.error("Error parsing keywords list:", e);
                }
                
                // Add the keyword from the input field if it's not empty and not already in the list
                if (keywords && !keywordsList.includes(keywords)) {
                    keywordsList.push(keywords);
                }
                
                const location = $('#location').val();
                const country = $('#country').val();
                const maxPages = $('#maxPages').val() ? parseInt($('#maxPages').val()) :
                5;
                const maxDaysOld = parseInt($('#max_days_old').val());
                const remoteOnly = $('#remote_only').is(':checked');
                
                // Save settings first
                saveJobSearch();
                
                // Show status alert
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Syncing jobs... This may take a few minutes.');
                
                // Record start time
                syncStartTime = new Date();
                
                // Start the sync
                $.ajax({
                    url: '/api/jobs/sync',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        keywords: keywords,
                        keywords_list: keywordsList,
                        location: location,
                        country: country,
                        max_pages: maxPages,
                        max_days_old: maxDaysOld,
                        remote_only: remoteOnly
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> Job sync successfully started. Reload the page in a few minutes to see new jobs.`);
                            
                            // Reload after a delay to show the latest data
                            setTimeout(function() {
                                location.reload();
                            }, 30000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Import to main storage
            function importToMainStorage() {
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Importing jobs to main storage...');
                
                $.ajax({
                    url: '/api/adzuna/import',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        days: 30
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> ${response.jobs_imported} jobs imported to main storage.`);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Clean up old jobs
            function cleanupOldJobs() {
                if (!confirm('This will remove jobs older than 90 days. Continue?')) {
                    return;
                }
                
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Cleaning up old jobs...');
                
                $.ajax({
                    url: '/api/adzuna/cleanup',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        max_age: 90
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> ${response.jobs_removed} old jobs removed.`);
                            
                            // Reload after a delay
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Save job search parameters
            function saveJobSearch() {
                // Get form values
                const keywords = $('#keywords').val();
                const location = $('#location').val();
                const country = $('#country').val();
                const maxDaysOld = $('#max_days_old').val();
                const remoteOnly = $('#remote_only').is(':checked') ? '1' : '';
                const maxPages = $('#maxPages').val();
                
                // Get keywords list from hidden input
                let keywordsList = [];
                try {
                    const keywordsListData = $('#keywordsListData').val();
                    if (keywordsListData) {
                        keywordsList = JSON.parse(keywordsListData);
                    }
                } catch (e) {
                    console.error("Error parsing keywords list in saveJobSearch:", e);
                }
                
                // Store values in session/browser storage for persistence
                localStorage.setItem('job_search_keywords', keywords);
                localStorage.setItem('job_search_keywords_list', JSON.stringify(keywordsList));
                localStorage.setItem('job_search_location', location);
                localStorage.setItem('job_search_country', country);
                localStorage.setItem('job_search_max_days_old', maxDaysOld);
                localStorage.setItem('job_search_remote_only', remoteOnly);
                localStorage.setItem('job_search_max_pages', maxPages);
                
                // Show confirmation message
                $('#syncStatus').show().removeClass('alert-info alert-danger').addClass('alert-success');
                $('#syncStatusText').html('<i class="fas fa-check-circle"></i> Settings saved successfully.');
                
                // Auto-hide after a few seconds
                setTimeout(function() {
                    $('#syncStatus').fadeOut();
                }, 3000);
            }
            
            // Export jobs
            function exportJobs() {
                // Simple export to CSV
                alert('Export feature to be implemented.');
            }
            
            // Initialize job tables with proper configuration
            // Function to delete a batch
            function deleteBatch(batchId) {
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').text('Deleting batch...');
                
                $.ajax({
                    url: `/api/adzuna/batch/${batchId}`,
                    method: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> Batch deleted successfully.`);
                            
                            // Remove the row from the table
                            $(`button.delete-batch[data-batch-id="${batchId}"]`).closest('tr').remove();
                            
                            // Reload the page after a short delay to refresh the data
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            function initializeJobTables() {
                try {
                    // Wait for the DOM to be fully ready
                    $(document).ready(function() {
                        // Super basic configuration - minimum features to ensure it works
                        const tableConfig = {
                            pageLength: 10,
                            processing: true,
                            retrieve: true // Allow the table to be retrieved again
                        };
                        
                        // Special config for job tables (with match percentage)
                        const jobTableConfig = {
                            ...tableConfig,
                            order: [[6, 'desc']], // Sort by match percentage column by default
                            columnDefs: [
                                {
                                    targets: 6, // Match percentage column
                                    render: function(data, type, row) {
                                        if (type === 'sort' || type === 'type') {
                                            // Extract numeric part for sorting
                                            return parseFloat(data) || 0;
                                        }
                                        return data;
                                    }
                                }
                            ]
                        };
                        
                        // Special config for batch summary table
                        const batchTableConfig = {
                            ...tableConfig,
                            order: [[1, 'desc']], // Sort by timestamp by default
                            columnDefs: []
                        };
                        
                        // Initialize all tables with a delay to ensure DOM is ready
                        setTimeout(function() {
                            $('.job-table').each(function() {
                                // Skip if table has no rows besides the empty message
                                if ($(this).find('tbody tr').length === 0 || 
                                    ($(this).find('tbody tr').length === 1 && 
                                     $(this).find('tbody tr:first td').length === 1) ||
                                    ($(this).find('tbody tr:first td:first').text().trim() === 'No jobs found' ||
                                     $(this).find('tbody tr:first td:first').text().trim() === 'No recent jobs found' ||
                                     $(this).find('tbody tr:first td:first').text().trim() === 'No remote jobs found' ||
                                     $(this).find('tbody tr:first td:first').text().trim() === 'No data available')) {
                                    console.log("Skipping empty table:", $(this).attr('id'));
                                    return;
                                }
                                
                                try {
                                    const tableId = '#' + $(this).attr('id');
                                    
                                    // Destroy existing table if it exists
                                    if ($.fn.DataTable.isDataTable(tableId)) {
                                        $(tableId).DataTable().destroy();
                                    }
                                    
                                    // Check if table has a header row
                                    if ($(tableId + ' thead tr th').length === 0) {
                                        console.log("Table has no header row:", tableId);
                                        return;
                                    }
                                    
                                    // Create new table with safer configuration and error handling
                                    try {
                                        let config = tableConfig;
                                        
                                        // Use appropriate config based on table type
                                        if (tableId === '#batchSummaryTable') {
                                            config = batchTableConfig;
                                        } else if (['#jobsTable', '#recentJobsTable', '#remoteJobsTable'].includes(tableId)) {
                                            config = jobTableConfig;
                                        }
                                        
                                        const table = $(tableId).DataTable({
                                            ...config,
                                            // Handle errors gracefully
                                            language: {
                                                emptyTable: tableId === '#batchSummaryTable' ? "No batches available" : "No job data available"
                                            }
                                        });
                                        jobTables[tableId] = table;
                                        console.log("Table initialized:", tableId);
                                    } catch (dtError) {
                                        console.error("DataTables initialization error:", dtError);
                                    }
                                } catch (tableError) {
                                    console.error("Error initializing table:", $(this).attr('id'), tableError);
                                }
                            });
                        });
                        
                        // If a resume is already selected, match jobs
                        if (currentResumeId) {
                            getJobMatchesForResume(currentResumeId);
                        }
                        
                        console.log("Tables initialization complete");
                    }, 500);
                } catch (error) {
                    console.error("Error in table initialization function:", error);
                }
            }
            
            // Get job matches for a selected resume
            function getJobMatchesForResume(resumeId) {
                // Show loading indicator
                $('#syncStatus').show().removeClass('alert-success alert-danger').addClass('alert-info');
                $('#syncStatusText').html('<i class="fas fa-spinner fa-spin"></i> Matching resume to jobs...');
                
                $.ajax({
                    url: '/api/match-jobs',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        resume_id: resumeId
                    }),
                    success: function(response) {
                        if (response.success) {
                            // Update job match percentages in tables
                            updateJobMatchPercentages(response.matches);
                            
                            // Show success message
                            $('#syncStatus').removeClass('alert-info').addClass('alert-success');
                            $('#syncStatusText').html(`<i class="fas fa-check-circle"></i> Resume matched to ${Object.keys(response.matches).length} jobs successfully.`);
                            
                            // Auto-hide message after a delay
                            setTimeout(function() {
                                $('#syncStatus').fadeOut();
                            }, 3000);
                        } else {
                            $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                            $('#syncStatusText').html(`<i class="fas fa-exclamation-circle"></i> Error: ${response.error || 'Unknown error'}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#syncStatus').removeClass('alert-info').addClass('alert-danger');
                        let errorMsg = 'Unknown error';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (error) {
                            errorMsg = error;
                        }
                        
                        $('#syncStatusText').html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                    }
                });
            }
            
            // Update job match percentages in tables
            function updateJobMatchPercentages(matches) {
                console.log("Updating job match percentages with matches:", matches);

                $('.job-table').each(function() {
                    const tableId = '#' + $(this).attr('id');
                    
                    // Skip batch summary table
                    if (tableId === '#batchSummaryTable') {
                        return;
                    }

                    if (!$.fn.DataTable.isDataTable(tableId)) {
                        console.log("Table not initialized:", tableId);
                        return;
                    }

                    const table = $(tableId).DataTable();
                    let updatedRows = 0;

                    $(tableId + ' tbody tr.job-row').each(function() {
                        const jobRow = $(this);
                        const jobId = jobRow.data('job-id');

                        let matchFound = false;
                        let matchPercentage = 0;

                        if (matches[jobId]) {
                            matchPercentage = matches[jobId];
                            matchFound = true;
                        } else if (jobId && typeof jobId === 'string' && jobId.includes('-')) {
                            const baseJobId = jobId.split('-')[1];
                            if (matches[baseJobId]) {
                                matchPercentage = matches[baseJobId];
                                matchFound = true;
                            }
                        } else if (jobId && matches[String(jobId)]) {
                            matchPercentage = matches[String(jobId)];
                            matchFound = true;
                        }

                        if (matchFound) {
                            updatedRows++;
                            const formattedMatch = matchPercentage + '%';

                            // Update match % explicitly using DataTables API
                            const cell = table.cell(jobRow.find('td:eq(6)'));
                            cell.data(formattedMatch);
                        }
                    });

                    console.log(`Updated ${updatedRows} rows in table ${tableId}`);

                    // Redraw explicitly after updating all rows
                    if (updatedRows > 0) {
                        try {
                            table.order([6, 'desc']).draw(false);
                        } catch (sortError) {
                            console.error("Error sorting table:", sortError);
                        }
                    }
                });
            }
        </script>
</body>
</html>
